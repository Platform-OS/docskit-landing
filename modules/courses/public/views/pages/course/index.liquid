---
slug: course(/:id)
layout: modules/courses/courses
---
{% liquid
  function current_user = 'modules/user/lib/queries/user/current'

  unless current_user.id
    redirect_to '/user/login'
  endunless

  function can_view_all = 'modules/permission/lib/helpers/can_do', requester: current_user, do: 'courses.manage'

  if can_view_all
    assign status = '["published", "unpublished"]' | parse_json
  endif

  graphql modules = 'modules/courses/module/search', withLessons: true, status: status
  assign modules = modules.records.results

  assign current_lesson = modules.first.lessons.first

  if current_lesson == blank and can_view_all
    redirect_to '/admin'
  endif

  if params.id
    graphql current_lesson = 'modules/courses/lesson/find', id: params.id, status: status
    assign current_lesson = current_lesson.records.results.first
  endif

  unless current_lesson.status == 'published' or can_view_all and current_lesson
    redirect_to '/course'
  endunless
%}

{% theme_render_rc 'components/templates/course', modules: modules, current_lesson: current_lesson %}
